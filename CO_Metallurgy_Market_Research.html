<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CO Market Research: Metallurgical Applications</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Plotly.js -->
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>

    <!-- Google Fonts: Roboto for Material Design feel -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">

    <!-- Markdown Parser for AI Responses -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        /* Base Settings */
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #F3F4F6; /* Light Gray Background */
            color: #1F2937; /* Dark Gray Text */
        }

        /* Palette Definition (Vibrant Tech) 
           Primary Blue: #2563EB
           Secondary Cyan: #06B6D4
           Accent Orange: #F97316
           Success Emerald: #10B981
           Dark Violet: #7C3AED
        */

        /* Chart Container Rules - MANDATORY */
        .chart-container {
            position: relative;
            width: 100%;
            margin-left: auto;
            margin-right: auto;
            background-color: white;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            padding: 1rem;
        }

        /* Responsive Heights for Charts */
        .chart-height-sm { height: 300px; max-height: 300px; }
        .chart-height-md { height: 400px; max-height: 400px; }
        .chart-height-lg { height: 500px; max-height: 500px; }

        @media (min-width: 768px) {
            .chart-container {
                padding: 1.5rem;
            }
        }

        /* Diagram Connector Lines (CSS Only - No SVG) */
        .connector-line-vertical {
            width: 2px;
            background-color: #9CA3AF;
            height: 2rem;
            margin: 0 auto;
        }
        
        .connector-line-horizontal {
            height: 2px;
            background-color: #9CA3AF;
            width: 100%;
            margin: auto 0;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1; 
        }
        ::-webkit-scrollbar-thumb {
            background: #2563EB; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #1D4ED8; 
        }

        /* AI Loading Animation */
        .shimmer {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }
        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
    </style>
</head>
<body class="text-gray-800 antialiased">

    <!-- Header / Hero Section -->
    <header class="bg-gradient-to-r from-blue-700 to-cyan-600 text-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4 py-12 sm:px-6 lg:px-8">
            <h1 class="text-4xl md:text-5xl font-bold tracking-tight mb-4">
                The Future of On-Site CO Production
            </h1>
            <p class="text-xl md:text-2xl text-blue-100 max-w-3xl">
                Optimizing Supply for 1-10 TPD: Market research and technological analysis for metallurgical Carbon Monoxide supply.
            </p>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 py-8 sm:px-6 lg:px-8 space-y-12">

        <!-- Executive Summary Cards -->
        <section class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="bg-white rounded-lg shadow-md p-6 border-l-4 border-blue-600">
                <h3 class="text-sm font-medium text-gray-500 uppercase">Target Volume</h3>
                <p class="mt-2 text-3xl font-bold text-gray-900">1 - 10 TPD</p>
                <p class="mt-1 text-sm text-gray-600">The specialized volume range between cylinders and large SMRs.</p>
            </div>
            <div class="bg-white rounded-lg shadow-md p-6 border-l-4 border-orange-500">
                <h3 class="text-sm font-medium text-gray-500 uppercase">Purity Requirement</h3>
                <p class="mt-2 text-3xl font-bold text-gray-900">> 99.5%</p>
                <p class="mt-1 text-sm text-gray-600">Critical for Nickel purification and preventing metal embrittlement.</p>
            </div>
            <div class="bg-white rounded-lg shadow-md p-6 border-l-4 border-emerald-500">
                <h3 class="text-sm font-medium text-gray-500 uppercase">Cost Target</h3>
                <p class="mt-2 text-3xl font-bold text-gray-900">< $1.00 / kg</p>
                <p class="mt-1 text-sm text-gray-600">Beating delivered liquid CO prices through on-site generation.</p>
            </div>
        </section>

        <!-- NEW: AI CONSULTANT SECTION -->
        <section id="ai-consultant" class="bg-gradient-to-br from-indigo-50 to-white rounded-xl shadow-lg border border-indigo-100 overflow-hidden hidden">
            <div class="p-6 md:p-8">
                <div class="flex items-center gap-3 mb-6">
                    <div class="bg-indigo-600 text-white p-2 rounded-lg">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                    </div>
                    <div>
                        <h2 class="text-2xl font-bold text-gray-900">Interactive Strategy Consultant</h2>
                        <p class="text-sm text-gray-500">Powered by Gemini 2.5 Flash</p>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <!-- Input Form -->
                    <div class="lg:col-span-1 space-y-5">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Target Production (TPD)</label>
                            <input type="range" id="tpdInput" min="1" max="15" step="0.5" value="5" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-indigo-600" oninput="document.getElementById('tpdValue').innerText = this.value + ' TPD'">
                            <div class="flex justify-between text-xs text-gray-500 mt-1">
                                <span>1 TPD</span>
                                <span id="tpdValue" class="font-bold text-indigo-600">5 TPD</span>
                                <span>15 TPD</span>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Purity Requirement</label>
                            <select id="purityInput" class="w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 p-2 border">
                                <option value="98.0">Standard Chemical (98%)</option>
                                <option value="99.5" selected>Metallurgical / DRI (99.5%)</option>
                                <option value="99.9">Nickel Carbonyl (99.9%)</option>
                                <option value="99.999">Electronic Grade (5N)</option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Local Electricity Cost</label>
                            <select id="energyInput" class="w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 p-2 border">
                                <option value="Low (< $0.05/kWh)">Low (< $0.05/kWh)</option>
                                <option value="Medium ($0.08 - $0.12/kWh)" selected>Medium ($0.08 - $0.12/kWh)</option>
                                <option value="High (> $0.15/kWh)">High (> $0.15/kWh)</option>
                            </select>
                        </div>

                        <button onclick="generateStrategy()" class="w-full flex items-center justify-center bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg transition duration-200 shadow-md transform hover:-translate-y-0.5">
                            ‚ú® Generate Recommendation
                        </button>
                    </div>

                    <!-- Output Area -->
                    <div class="lg:col-span-2 bg-white rounded-lg border border-gray-200 p-6 min-h-[300px] flex flex-col">
                        <h3 class="text-sm font-bold text-gray-400 uppercase tracking-wider mb-4">Consultant Analysis</h3>
                        
                        <!-- Placeholder State -->
                        <div id="aiPlaceholder" class="flex-1 flex flex-col items-center justify-center text-gray-400 text-center">
                            <svg class="w-12 h-12 mb-3 opacity-20" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path></svg>
                            <p>Configure parameters and click "Generate" to receive a custom technology recommendation.</p>
                        </div>

                        <!-- Loading State -->
                        <div id="aiLoading" class="hidden flex-1 space-y-4 animate-pulse">
                            <div class="h-4 bg-gray-200 rounded w-3/4"></div>
                            <div class="h-4 bg-gray-200 rounded w-1/2"></div>
                            <div class="h-20 bg-gray-200 rounded w-full"></div>
                            <div class="h-4 bg-gray-200 rounded w-5/6"></div>
                        </div>

                        <!-- Result State -->
                        <div id="aiResult" class="hidden prose prose-sm max-w-none text-gray-700">
                            <!-- Content injected here -->
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Section 1: The Supply Gap Analysis -->
        <section>
            <div class="mb-6">
                <h2 class="text-3xl font-bold text-gray-900 mb-2">Market Segmentation & Supply Modes</h2>
                <div class="w-20 h-1 bg-orange-500 mb-4"></div>
                <p class="text-lg text-gray-600 leading-relaxed max-w-4xl">
                    The Carbon Monoxide market is traditionally segmented into two extremes. Users needing small amounts (< 0.1 TPD) typically rely on cylinders, while large-scale chemical plants (> 100 TPD) use dedicated pipelines or large SMRs.
                    <br><br>
                    <strong>Metallurgical processors requiring 1-10 tonnes per day face unique challenges.</strong> This specific volume range often necessitates paying premium prices for liquid delivery or tube trailers, incurring significant logistical costs. This chart maps the cost-to-volume relationship, highlighting the distinct requirements of this segment.
                </p>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Chart Container -->
                <div class="lg:col-span-2 chart-container chart-height-md">
                    <canvas id="gapBubbleChart"></canvas>
                </div>
                
                <!-- Chart Context/Legend -->
                <div class="bg-white rounded-lg shadow-md p-6 flex flex-col justify-center">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Market Dynamics</h3>
                    <ul class="space-y-4">
                        <li class="flex items-start">
                            <span class="flex-shrink-0 h-4 w-4 rounded-full bg-gray-400 mt-1 mr-3"></span>
                            <div>
                                <span class="font-bold block text-gray-700">Traditional Delivery</span>
                                <span class="text-sm text-gray-600">High cost ($2-$6/kg). Reliability issues due to hazardous transport regulations.</span>
                            </div>
                        </li>
                        <li class="flex items-start">
                            <span class="flex-shrink-0 h-4 w-4 rounded-full bg-blue-600 mt-1 mr-3"></span>
                            <div>
                                <span class="font-bold block text-gray-700">Large Scale SMR</span>
                                <span class="text-sm text-gray-600">Low cost ($0.3/kg) but requires massive CAPEX and volume (>100 TPD).</span>
                            </div>
                        </li>
                        <li class="flex items-start">
                            <span class="flex-shrink-0 h-4 w-4 rounded-full bg-orange-500 mt-1 mr-3 animate-pulse"></span>
                            <div>
                                <span class="font-bold block text-gray-700">Target Segment (1-10 TPD)</span>
                                <span class="text-sm text-gray-600">On-site generation tech (SOEC, Modular SMR) targeting this volume can unlock $1-2B in market value.</span>
                            </div>
                        </li>
                    </ul>
                </div>
            </div>
        </section>

        <!-- Section 2: Metallurgical Purity Requirements -->
        <section>
            <div class="mb-6 flex justify-between items-end">
                <div>
                    <h2 class="text-3xl font-bold text-gray-900 mb-2">Metallurgical Purity Standards</h2>
                    <div class="w-20 h-1 bg-blue-600 mb-4"></div>
                </div>
                <!-- Mini AI Feature: Summarize Purity -->
                <button onclick="summarizeSection('purity')" class="hidden md:flex items-center text-xs font-bold text-blue-600 bg-blue-50 px-3 py-2 rounded hover:bg-blue-100 transition hidden">
                    ‚ú® Summarize for Lab Tech
                </button>
            </div>
            <p class="text-lg text-gray-600 leading-relaxed max-w-4xl mb-6">
                In metallurgy, CO is not just fuel; it is a precision chemical reagent. Impurities like water vapor, sulfur, or oxygen can cause oxidation or hydrogen embrittlement in high-performance alloys. 
                Unlike general chemical synthesis, <strong>nickel purification and electronic alloy production demand ultra-high purity (>99.9%)</strong>, making standard Syngas (mixture of H2/CO) unsuitable without extensive purification.
            </p>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="chart-container chart-height-md">
                    <canvas id="purityBarChart"></canvas>
                </div>
                
                <!-- Key Takeaways for Purity -->
                <div class="space-y-6">
                    <div class="bg-white rounded-lg shadow p-5 border-l-4 border-indigo-500">
                        <h4 class="font-bold text-lg text-gray-800">Reducing Agent (Iron/Steel)</h4>
                        <p class="text-gray-600 mt-2">Requires <strong>99.5%</strong> purity. Essential for Direct Reduced Iron (DRI) processes where carbon potential must be strictly controlled.</p>
                    </div>
                    <div class="bg-white rounded-lg shadow p-5 border-l-4 border-cyan-500">
                        <h4 class="font-bold text-lg text-gray-800">Nickel Carbonyl Process</h4>
                        <p class="text-gray-600 mt-2">Requires <strong>99.9%</strong> purity. CO binds with Nickel to form gas phase Carbonyls. Impurities interfere with the reversible reaction.</p>
                    </div>
                    <div class="bg-white rounded-lg shadow p-5 border-l-4 border-orange-500">
                        <h4 class="font-bold text-lg text-gray-800">Electronic Alloys</h4>
                        <p class="text-gray-600 mt-2">Requires <strong>99.999%</strong> (5N) purity. Used in semiconductor manufacturing where even ppb-level contaminants ruin the wafer.</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Section 3: Cost Structure Analysis -->
        <section class="bg-white rounded-xl shadow-lg p-6 md:p-10">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-12 items-center">
                <div>
                    <h2 class="text-3xl font-bold text-gray-900 mb-4">The Economic Case for On-Site</h2>
                    <p class="text-lg text-gray-600 mb-6">
                        Why is Delivered CO so expensive? <strong>Logistics.</strong>
                        <br><br>
                        Moving CO requires specialized cryogenic tankers or heavy high-pressure tubes. The "molecule cost" is low, but the "delivered cost" is dominated by transport, hazmat compliance, and rental fees.
                        <br><br>
                        On-site generation flips this model. The majority of the cost shifts to CAPEX amortization and energy, resulting in a predictable, lower long-term price per kg, free from supply chain volatility.
                    </p>
                    <div class="flex items-center space-x-4">
                        <div class="text-center p-4 bg-gray-50 rounded-lg">
                            <span class="block text-3xl font-bold text-red-500">65%</span>
                            <span class="text-xs text-gray-500 uppercase">of Delivered Cost is Logistics</span>
                        </div>
                        <div class="text-center p-4 bg-gray-50 rounded-lg">
                            <span class="block text-3xl font-bold text-green-500">40%</span>
                            <span class="text-xs text-gray-500 uppercase">Savings via On-Site</span>
                        </div>
                    </div>
                </div>

                <div class="chart-container chart-height-md">
                    <canvas id="costStackChart"></canvas>
                </div>
            </div>
        </section>

        <!-- Section 4: Technology Assessment -->
        <section>
            <div class="mb-8 text-center max-w-4xl mx-auto">
                <h2 class="text-3xl font-bold text-gray-900 mb-2">Technology Landscape for 1-10 TPD</h2>
                <div class="w-20 h-1 bg-emerald-500 mx-auto mb-4"></div>
                <p class="text-lg text-gray-600">
                    Which technology wins at this specific scale? Large SMRs are too big. Cylinders are too small. 
                    We evaluated four key contenders: <strong>Modular SMR + PSA</strong>, <strong>Membrane Separation</strong>, <strong>Cryogenic Distillation</strong>, and emerging <strong>Solid Oxide Electrolysis (SOEC)</strong>.
                </p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <!-- Radar Chart -->
                <div class="chart-container chart-height-lg">
                    <canvas id="techRadarChart"></canvas>
                </div>

                <!-- Tech Breakdown Cards -->
                <div class="grid grid-cols-1 gap-4">
                    <div class="bg-white p-4 rounded shadow border-l-4 border-blue-600">
                        <h4 class="font-bold text-blue-800">Membranes</h4>
                        <p class="text-sm text-gray-600">Excellent modularity and low CAPEX. Best for adjusting H2:CO ratios but struggles to hit 99.9% purity without multiple stages.</p>
                    </div>
                    <div class="bg-white p-4 rounded shadow border-l-4 border-indigo-600">
                        <h4 class="font-bold text-indigo-800">PSA (Adsorption)</h4>
                        <p class="text-sm text-gray-600">The industry workhorse. Reliable and scales well down to 5 TPD. Good purity (99.5%), but yield can be lower than chemical methods.</p>
                    </div>
                    <div class="bg-white p-4 rounded shadow border-l-4 border-cyan-500">
                        <h4 class="font-bold text-cyan-700">Cryogenic</h4>
                        <p class="text-sm text-gray-600">The king of purity (>99.99%). However, CAPEX is very high for small volumes. Only viable if ultra-high purity is strictly mandatory.</p>
                    </div>
                    <div class="bg-white p-4 rounded shadow border-l-4 border-orange-500">
                        <h4 class="font-bold text-orange-700">SOEC (Electrolysis)</h4>
                        <p class="text-sm text-gray-600">The future contender. Converts CO2 directly to CO using electricity. Perfect for decarbonization mandates ("Green Steel"), though currently high CAPEX.</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Section 5: On-Site Process Diagram (HTML/Tailwind) -->
        <section class="bg-gray-100 rounded-xl p-8 border border-gray-200">
            <h2 class="text-2xl font-bold text-gray-900 mb-8 text-center">Typical On-Site CO Generation Process</h2>
            
            <div class="max-w-5xl mx-auto">
                <!-- Process Flex Container -->
                <div class="flex flex-col md:flex-row items-stretch justify-between gap-4 relative">
                    
                    <!-- Step 1: Feedstock -->
                    <div class="flex-1 bg-white rounded-lg shadow-md p-4 text-center border-t-4 border-gray-500 relative z-10">
                        <div class="text-3xl mb-2">üè≠</div>
                        <h4 class="font-bold text-gray-800">Feedstock</h4>
                        <p class="text-xs text-gray-500 mt-1">Natural Gas (CH4)<br>or Biogas/CO2</p>
                    </div>

                    <!-- Connector Arrow (Horizontal for Desktop) -->
                    <div class="hidden md:flex flex-col justify-center w-12">
                        <div class="h-1 bg-blue-300 w-full relative">
                            <div class="absolute right-0 -top-1.5 w-0 h-0 border-t-8 border-t-transparent border-l-[12px] border-l-blue-300 border-b-8 border-b-transparent"></div>
                        </div>
                    </div>
                    <!-- Connector Arrow (Vertical for Mobile) -->
                    <div class="md:hidden flex justify-center h-8">
                        <div class="w-1 bg-blue-300 h-full relative">
                             <div class="absolute bottom-0 -left-1.5 w-0 h-0 border-l-8 border-l-transparent border-t-[12px] border-t-blue-300 border-r-8 border-r-transparent"></div>
                        </div>
                    </div>

                    <!-- Step 2: Generation -->
                    <div class="flex-1 bg-white rounded-lg shadow-md p-4 text-center border-t-4 border-blue-600 relative z-10">
                        <div class="text-3xl mb-2">‚ö°</div>
                        <h4 class="font-bold text-gray-800">Conversion</h4>
                        <p class="text-xs text-gray-500 mt-1">Reforming / SOEC<br>Syngas Creation</p>
                    </div>

                     <!-- Connector Arrow -->
                     <div class="hidden md:flex flex-col justify-center w-12">
                        <div class="h-1 bg-blue-300 w-full relative">
                            <div class="absolute right-0 -top-1.5 w-0 h-0 border-t-8 border-t-transparent border-l-[12px] border-l-blue-300 border-b-8 border-b-transparent"></div>
                        </div>
                    </div>
                    <div class="md:hidden flex justify-center h-8">
                        <div class="w-1 bg-blue-300 h-full relative">
                             <div class="absolute bottom-0 -left-1.5 w-0 h-0 border-l-8 border-l-transparent border-t-[12px] border-t-blue-300 border-r-8 border-r-transparent"></div>
                        </div>
                    </div>

                    <!-- Step 3: Purification -->
                    <div class="flex-1 bg-white rounded-lg shadow-md p-4 text-center border-t-4 border-indigo-600 relative z-10">
                        <div class="text-3xl mb-2">üß™</div>
                        <h4 class="font-bold text-gray-800">Purification</h4>
                        <p class="text-xs text-gray-500 mt-1">PSA / Membranes<br>Removes H2, H2O, CO2</p>
                    </div>

                     <!-- Connector Arrow -->
                     <div class="hidden md:flex flex-col justify-center w-12">
                        <div class="h-1 bg-blue-300 w-full relative">
                            <div class="absolute right-0 -top-1.5 w-0 h-0 border-t-8 border-t-transparent border-l-[12px] border-l-blue-300 border-b-8 border-b-transparent"></div>
                        </div>
                    </div>
                    <div class="md:hidden flex justify-center h-8">
                        <div class="w-1 bg-blue-300 h-full relative">
                             <div class="absolute bottom-0 -left-1.5 w-0 h-0 border-l-8 border-l-transparent border-t-[12px] border-t-blue-300 border-r-8 border-r-transparent"></div>
                        </div>
                    </div>

                    <!-- Step 4: End Use -->
                    <div class="flex-1 bg-white rounded-lg shadow-md p-4 text-center border-t-4 border-orange-500 relative z-10 ring-4 ring-orange-100">
                        <div class="text-3xl mb-2">‚öôÔ∏è</div>
                        <h4 class="font-bold text-gray-800">Application</h4>
                        <p class="text-xs text-gray-500 mt-1">Metallurgy (Reducing)<br>Ni Purification</p>
                    </div>

                </div>
            </div>
        </section>

        <!-- Conclusion -->
        <footer class="mt-12 text-center text-gray-500 text-sm pb-8">
            <p>Source Material Analysis: CO Markets and Requirements ‚Ä¢ 2025</p>
        </footer>

    </main>

    <!-- JavaScript for Charts and Logic -->
    <script>
        // --- HELPER FUNCTION: Label Wrapping ---
        // Splits long strings into arrays of shorter strings for Chart.js multiline support
        function wrapLabel(label, maxLength = 16) {
            if (label.length <= maxLength) return label;
            const words = label.split(' ');
            const lines = [];
            let currentLine = words[0];

            for (let i = 1; i < words.length; i++) {
                if ((currentLine + " " + words[i]).length <= maxLength) {
                    currentLine += " " + words[i];
                } else {
                    lines.push(currentLine);
                    currentLine = words[i];
                }
            }
            lines.push(currentLine);
            return lines;
        }

        // --- HELPER CONFIG: Tooltips ---
        // Ensures arrays (multiline labels) are joined back to strings in tooltips
        const commonTooltipOptions = {
            callbacks: {
                title: function(tooltipItems) {
                    const item = tooltipItems[0];
                    let label = item.chart.data.labels[item.dataIndex];
                    if (Array.isArray(label)) {
                        return label.join(' ');
                    } else {
                        return label;
                    }
                }
            }
        };

        // --- CHART 1: The Supply Gap Bubble Chart ---
        const ctxGap = document.getElementById('gapBubbleChart').getContext('2d');
        new Chart(ctxGap, {
            type: 'bubble',
            data: {
                datasets: [
                    {
                        label: 'Cylinders',
                        data: [{x: 0.1, y: 5.0, r: 8}],
                        backgroundColor: '#9CA3AF' // Gray
                    },
                    {
                        label: 'Tube Trailers',
                        data: [{x: 1.5, y: 3.5, r: 12}],
                        backgroundColor: '#6B7280' // Dark Gray
                    },
                    {
                        label: 'Target Volume (1-10 TPD)',
                        data: [{x: 5, y: 1.2, r: 25}], // The sweet spot
                        backgroundColor: '#F97316', // Orange Accent
                        borderColor: '#C2410C',
                        borderWidth: 2
                    },
                    {
                        label: 'Small SMR',
                        data: [{x: 50, y: 0.8, r: 18}],
                        backgroundColor: '#2563EB' // Blue
                    },
                    {
                        label: 'Large Pipeline',
                        data: [{x: 300, y: 0.4, r: 30}],
                        backgroundColor: '#1E3A8A' // Dark Blue
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        type: 'logarithmic',
                        title: { display: true, text: 'Production Scale (Tonnes Per Day) [Log Scale]' },
                        min: 0.05,
                        max: 500
                    },
                    y: {
                        title: { display: true, text: 'Unit Cost ($ / kg)' },
                        min: 0,
                        max: 6
                    }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.dataset.label + ': ' + context.raw.y + ' $/kg @ ' + context.raw.x + ' TPD';
                            }
                        }
                    },
                    legend: {
                        position: 'bottom'
                    },
                    title: {
                        display: true,
                        text: 'Cost vs. Scale: Supply Mode Economics',
                        font: { size: 16 }
                    }
                }
            }
        });

        // --- CHART 2: Purity Requirements (Horizontal Bar) ---
        const ctxPurity = document.getElementById('purityBarChart').getContext('2d');
        const purityLabels = ['Standard Chemical', 'Metallurgy (Reducing)', 'Nickel Carbonyl', 'Electronic Alloys'];
        const wrappedPurityLabels = purityLabels.map(l => wrapLabel(l));

        new Chart(ctxPurity, {
            type: 'bar',
            data: {
                labels: wrappedPurityLabels,
                datasets: [{
                    label: 'Minimum Purity Required (%)',
                    data: [98.0, 99.5, 99.9, 99.999],
                    backgroundColor: [
                        '#9CA3AF', // Gray
                        '#2563EB', // Blue
                        '#06B6D4', // Cyan
                        '#F97316'  // Orange (Highest req)
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        min: 97,
                        max: 100,
                        title: { display: true, text: 'Purity Percentage (%)' }
                    }
                },
                plugins: {
                    tooltip: commonTooltipOptions,
                    legend: { display: false },
                    title: {
                        display: true,
                        text: 'Purity Criticality by Application'
                    }
                }
            }
        });

        // --- CHART 3: Cost Stack Analysis (Stacked Bar) ---
        const ctxCost = document.getElementById('costStackChart').getContext('2d');
        const costLabels = ['Delivered (Liquid)', 'On-Site Generation'];
        
        new Chart(ctxCost, {
            type: 'bar',
            data: {
                labels: costLabels,
                datasets: [
                    {
                        label: 'Production/Feedstock',
                        data: [0.4, 0.7], // Cheap production for bulk, Higher relative feedstock for small on-site
                        backgroundColor: '#2563EB' // Blue
                    },
                    {
                        label: 'Liquefaction/Energy',
                        data: [0.5, 0.3], 
                        backgroundColor: '#06B6D4' // Cyan
                    },
                    {
                        label: 'Logistics/Transport',
                        data: [1.5, 0.0], // Huge cost for delivered
                        backgroundColor: '#F97316' // Orange
                    },
                    {
                        label: 'Compliance/Rental',
                        data: [0.6, 0.1], // Hazmat fees vs small maintenance
                        backgroundColor: '#9CA3AF' // Gray
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: { stacked: true },
                    y: { 
                        stacked: true,
                        title: { display: true, text: 'Cost Contribution ($ / kg)' }
                    }
                },
                plugins: {
                    tooltip: commonTooltipOptions,
                    title: {
                        display: true,
                        text: 'Cost Breakdown: Where does the money go?'
                    }
                }
            }
        });

        // --- CHART 4: Technology Radar ---
        const ctxRadar = document.getElementById('techRadarChart').getContext('2d');
        
        new Chart(ctxRadar, {
            type: 'radar',
            data: {
                labels: ['Scalability (Down)', 'High Purity', 'Low CAPEX', 'Low Energy', 'Ease of Operation'],
                datasets: [
                    {
                        label: 'Membranes',
                        data: [5, 3, 5, 4, 5], // Good cheap simple, low purity
                        borderColor: '#2563EB',
                        backgroundColor: 'rgba(37, 99, 235, 0.2)',
                    },
                    {
                        label: 'PSA (Adsorption)',
                        data: [4, 4, 3, 3, 4], // Balanced
                        borderColor: '#10B981',
                        backgroundColor: 'rgba(16, 185, 129, 0.2)',
                    },
                    {
                        label: 'Cryogenic',
                        data: [1, 5, 1, 2, 2], // Great purity, terrible scale/cost
                        borderColor: '#9CA3AF',
                        backgroundColor: 'rgba(156, 163, 175, 0.2)',
                        borderDash: [5, 5]
                    },
                    {
                        label: 'SOEC (Future)',
                        data: [5, 5, 2, 3, 3], // Great potential, currently expensive
                        borderColor: '#F97316',
                        backgroundColor: 'rgba(249, 115, 22, 0.2)',
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    r: {
                        angleLines: { display: false },
                        suggestedMin: 0,
                        suggestedMax: 5,
                        ticks: { stepSize: 1, backdropColor: 'transparent' }
                    }
                },
                plugins: {
                    tooltip: commonTooltipOptions,
                    title: {
                        display: true,
                        text: 'Technology Suitability Score (5 = Best)'
                    }
                }
            }
        });

        // --- GEMINI API INTEGRATION ---
        
        async function generateStrategy() {
            const apiKey = ""; // API key is provided by the execution environment
            const tpd = document.getElementById('tpdInput').value;
            const purity = document.getElementById('purityInput').value;
            const energy = document.getElementById('energyInput').value;

            // UI State Management
            const placeholder = document.getElementById('aiPlaceholder');
            const loading = document.getElementById('aiLoading');
            const result = document.getElementById('aiResult');
            
            placeholder.classList.add('hidden');
            result.classList.add('hidden');
            loading.classList.remove('hidden');

            const userPrompt = `I am a metallurgical plant manager. I need ${tpd} Tonnes Per Day (TPD) of Carbon Monoxide. My purity requirement is ${purity}%. My local electricity cost is ${energy}. 
            Based on the following technologies: Modular SMR + PSA, Membrane Separation, Cryogenic Distillation, and SOEC.
            
            Task:
            1. Recommend the SINGLE best technology for my specific situation.
            2. Explain why in 2 concise sentences, citing cost or technical fit.
            3. Estimate if this is economically feasible compared to delivered liquid CO (approx $2-$4/kg).
            
            Format nicely with bold headers.`;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: userPrompt
                            }]
                        }]
                    })
                });

                if (!response.ok) throw new Error('API Request Failed');

                const data = await response.json();
                const aiText = data.candidates[0].content.parts[0].text;
                
                // Parse Markdown and display
                result.innerHTML = marked.parse(aiText);
                
                loading.classList.add('hidden');
                result.classList.remove('hidden');

            } catch (error) {
                console.error(error);
                loading.classList.add('hidden');
                result.innerHTML = `<p class="text-red-500">Error generating recommendation. Please try again.</p>`;
                result.classList.remove('hidden');
            }
        }

        async function summarizeSection(topic) {
            const apiKey = ""; // API key is provided by the execution environment
            let prompt = "";
            
            if (topic === 'purity') {
                prompt = "Act as a senior metallurgist. Explain briefly (2 sentences) why purity >99.5% is critical for DRI and Nickel purification to a lab technician student. Mention 'Hydrogen Embrittlement'.";
            }

            // Using alert for the "Mini" feature to keep UI clean, or could be a modal. 
            // For this implementation, I'll replace the button text temporarily to show it works, then revert.
            
            try {
                 const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                
                const data = await response.json();
                const text = data.candidates[0].content.parts[0].text;
                alert("üéì Expert Insight:\n\n" + text);
            } catch (e) {
                alert("Could not generate summary.");
            }
        }

    </script>
</body>
</html>